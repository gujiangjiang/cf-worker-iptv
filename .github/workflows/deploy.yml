name: Deploy to Cloudflare

# è§¦å‘æ¡ä»¶ï¼šæ¨é€åˆ° main åˆ†æ”¯ æˆ– æ‰‹åŠ¨è§¦å‘
on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy
    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout
        uses: actions/checkout@v4

      # 2. è®¾ç½® Node.js ç¯å¢ƒ
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # 3. ç»Ÿä¸€æ£€æµ‹æ‰€æœ‰å‡­è¯ (CF å¯†é’¥ + å¯†ç )
      - name: Check Credentials & Generate Report
        id: check_creds
        run: |
          # åˆå§‹åŒ–çŠ¶æ€å˜é‡
          MISSING_CF=false
          MISSING_PWD=false
          
          # æ£€æŸ¥ CF å¯†é’¥
          if [ -z "${{ secrets.CF_API_TOKEN }}" ] || [ -z "${{ secrets.CF_ACCOUNT_ID }}" ]; then
            MISSING_CF=true
          fi
          
          # æ£€æŸ¥å¯†ç 
          if [ -z "${{ secrets.PASSWORD }}" ]; then
            MISSING_PWD=true
          fi

          # --- åœºæ™¯ 1: ç¼ºå°‘ CF å¯†é’¥ (è·³è¿‡éƒ¨ç½²) ---
          if [ "$MISSING_CF" = true ]; then
            echo "::warning::Cloudflare credentials missing. Deployment skipped."
            
            echo "## ğŸ›‘ éƒ¨ç½²å·²è·³è¿‡ (Deployment Skipped)" >> $GITHUB_STEP_SUMMARY
            echo "ç¼ºå°‘ Cloudflare è®¤è¯å¯†é’¥ï¼Œå·¥ä½œæµå·²è·³è¿‡ã€‚" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Secret | Status |" >> $GITHUB_STEP_SUMMARY
            echo "| --- | --- |" >> $GITHUB_STEP_SUMMARY
            
            if [ -z "${{ secrets.CF_API_TOKEN }}" ]; then
              echo "| CF_API_TOKEN | âŒ Missing |" >> $GITHUB_STEP_SUMMARY
            else
               echo "| CF_API_TOKEN | âœ… Found |" >> $GITHUB_STEP_SUMMARY
            fi

            if [ -z "${{ secrets.CF_ACCOUNT_ID }}" ]; then
              echo "| CF_ACCOUNT_ID | âŒ Missing |" >> $GITHUB_STEP_SUMMARY
            else
               echo "| CF_ACCOUNT_ID | âœ… Found |" >> $GITHUB_STEP_SUMMARY
            fi
            
            echo "should_deploy=false" >> $GITHUB_ENV
            exit 0 # ç»“æŸå½“å‰ stepï¼Œä¸æŠ¥é”™
          fi

          # --- åœºæ™¯ 2: CF å¯†é’¥å­˜åœ¨ï¼Œä½†ç¼ºå°‘ PASSWORD (è·³è¿‡éƒ¨ç½²) ---
          if [ "$MISSING_PWD" = true ]; then
            echo "::warning::PASSWORD secret missing. Deployment skipped."
            
            echo "## âš ï¸ éƒ¨ç½²å·²å–æ¶ˆ (Deployment Cancelled)" >> $GITHUB_STEP_SUMMARY
            echo "æ£€æµ‹åˆ° Cloudflare å¯†é’¥ï¼Œä½†ç¼ºå°‘åå°ç®¡ç†å¯†ç  (PASSWORD)ã€‚" >> $GITHUB_STEP_SUMMARY
            echo "è¯·åœ¨ Settings -> Secrets ä¸­æ·»åŠ  'PASSWORD'ã€‚" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Secret | Status |" >> $GITHUB_STEP_SUMMARY
            echo "| --- | --- |" >> $GITHUB_STEP_SUMMARY
            echo "| CF Credentials | âœ… Found |" >> $GITHUB_STEP_SUMMARY
            echo "| PASSWORD | âŒ Missing |" >> $GITHUB_STEP_SUMMARY
            
            echo "should_deploy=false" >> $GITHUB_ENV
            exit 0
          fi

          # --- åœºæ™¯ 3: ä¸€åˆ‡å°±ç»ª ---
          echo "All credentials found."
          echo "should_deploy=true" >> $GITHUB_ENV

      # 4. è‡ªåŠ¨åˆ›å»º KV å­˜å‚¨åº“å¹¶å…³è” (ä»…å½“ should_deploy ä¸º true æ—¶æ‰§è¡Œ)
      # ä¿®å¤ï¼šä½¿ç”¨ curl ç›´æ¥è°ƒç”¨ API æ›¿ä»£ wrangler CLIï¼Œé¿å…ç‰ˆæœ¬å’Œå‚æ•°è§£æé”™è¯¯
      - name: Auto Configure KV & Inject Secrets
        if: env.should_deploy == 'true'
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          USER_PASSWORD: ${{ secrets.PASSWORD }}
        run: |
          # å®šä¹‰ API åŸºç¡€å˜é‡
          API_URL="https://api.cloudflare.com/client/v4/accounts/${CLOUDFLARE_ACCOUNT_ID}/storage/kv/namespaces"
          AUTH_HEADER="Authorization: Bearer ${CLOUDFLARE_API_TOKEN}"
          
          echo "ğŸ” Checking for existing KV Namespace 'IPTV_KV'..."
          
          # ç›´æ¥é€šè¿‡ API è·å– KV åˆ—è¡¨ (æ¯é¡µ 100 æ¡ä»¥ç¡®ä¿èƒ½æ‰¾åˆ°)
          RESPONSE=$(curl -s -X GET "$API_URL?per_page=100" \
            -H "$AUTH_HEADER" \
            -H "Content-Type: application/json")
          
          # ä½¿ç”¨ jq è§£æ JSON æŸ¥æ‰¾ ID
          KV_ID=$(echo "$RESPONSE" | jq -r '.result[] | select(.title == "IPTV_KV") | .id')
          
          if [ -z "$KV_ID" ] || [ "$KV_ID" == "null" ]; then
            echo "âš ï¸ KV Namespace 'IPTV_KV' not found. Creating..."
            # åˆ›å»ºæ–°çš„ Namespace
            CREATE_RES=$(curl -s -X POST "$API_URL" \
              -H "$AUTH_HEADER" \
              -H "Content-Type: application/json" \
              --data '{"title": "IPTV_KV"}')
            
            KV_ID=$(echo "$CREATE_RES" | jq -r '.result.id')
            
            if [ -z "$KV_ID" ] || [ "$KV_ID" == "null" ]; then
              echo "::error::Failed to retrieve or create KV ID. API Response: $CREATE_RES"
              exit 1
            fi
            echo "âœ… Created new KV Namespace with ID: $KV_ID"
          else
            echo "âœ… Found existing KV Namespace ID: $KV_ID"
          fi

          echo "âš™ï¸ Updating wrangler.toml..."

          # 1. æ›¿æ¢ KV ID (åŒ¹é…ä¹‹å‰çš„å ä½ç¬¦ xxxxx...)
          sed -i "s/id = \"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\"/id = \"$KV_ID\"/g" wrangler.toml
          
          # 2. æ³¨å…¥å¯†ç  (æ›¿æ¢ PASSWORD = "..." æ ¼å¼)
          # ä½¿ç”¨åŒå¼•å·åŒ…è£¹ sed è¡¨è¾¾å¼ä»¥è§£æå˜é‡
          sed -i 's/PASSWORD = ".*"/PASSWORD = "'"$USER_PASSWORD"'"/' wrangler.toml
          
          echo "Configuration updated successfully."

      # 5. æ‰§è¡Œéƒ¨ç½² (ä»…å½“ should_deploy ä¸º true æ—¶æ‰§è¡Œ)
      - name: Deploy to Cloudflare Workers
        if: env.should_deploy == 'true'
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CF_API_TOKEN }}
          accountId: ${{ secrets.CF_ACCOUNT_ID }}
          command: deploy