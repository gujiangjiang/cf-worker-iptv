name: Deploy to Cloudflare

# è§¦å‘æ¡ä»¶ï¼šæ¨é€åˆ° main åˆ†æ”¯ æˆ– æ‰‹åŠ¨è§¦å‘
on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy
    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout
        uses: actions/checkout@v4

      # 2. è®¾ç½® Node.js ç¯å¢ƒ
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # 3. ç¬¬ä¸€æ­¥ï¼šæ£€æµ‹ Cloudflare ç§˜é’¥
      - name: Check Cloudflare Secrets
        run: |
          if [ -z "${{ secrets.CF_API_TOKEN }}" ]; then
            echo "::error::Missing CF_API_TOKEN secret. Please add it in GitHub Settings."
            exit 1
          fi
          if [ -z "${{ secrets.CF_ACCOUNT_ID }}" ]; then
            echo "::error::Missing CF_ACCOUNT_ID secret. Please add it in GitHub Settings."
            exit 1
          fi
          echo "Cloudflare credentials detected."

      # 4. ç¬¬äºŒæ­¥ï¼šæ£€æµ‹å¿…å¡«é¡¹ PASSWORD
      - name: Check Password Secret
        run: |
          if [ -z "${{ secrets.PASSWORD }}" ]; then
            echo "::error::Missing PASSWORD secret. Please add it in GitHub Settings."
            exit 1
          fi
          echo "User password detected."

      # 5. ç¬¬ä¸‰æ­¥ï¼šè‡ªåŠ¨åˆ›å»º KV å­˜å‚¨åº“å¹¶å…³è” (å«é…ç½®æ–‡ä»¶æ³¨å…¥)
      - name: Auto Configure KV & Inject Secrets
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          USER_PASSWORD: ${{ secrets.PASSWORD }}
        run: |
          # å®‰è£… wrangler ç”¨äº KV ç®¡ç†æ“ä½œ
          npm install -g wrangler

          echo "ğŸ” Checking KV Namespace 'IPTV_KV'..."
          
          # è·å–å½“å‰çš„ KV åˆ—è¡¨
          EXISTING_KV=$(npx wrangler kv:namespace list)
          
          # ä½¿ç”¨ jq æŸ¥æ‰¾åä¸º IPTV_KV çš„ ID
          KV_ID=$(echo "$EXISTING_KV" | jq -r '.[] | select(.title == "IPTV_KV") | .id')
          
          if [ -z "$KV_ID" ] || [ "$KV_ID" == "null" ]; then
            echo "âš ï¸ KV Namespace 'IPTV_KV' not found. Creating..."
            # åˆ›å»ºæ–°çš„ Namespace
            npx wrangler kv:namespace create IPTV_KV
            # é‡æ–°è·å– ID ä»¥ç¡®ä¿å‡†ç¡®
            KV_ID=$(npx wrangler kv:namespace list | jq -r '.[] | select(.title == "IPTV_KV") | .id')
            echo "âœ… Created new KV Namespace with ID: $KV_ID"
          else
            echo "âœ… Found existing KV Namespace ID: $KV_ID"
          fi
          
          if [ -z "$KV_ID" ] || [ "$KV_ID" == "null" ]; then
            echo "::error::Failed to retrieve or create KV ID."
            exit 1
          fi

          echo "âš™ï¸ Updating wrangler.toml..."

          # 1. æ›¿æ¢ KV ID (åŒ¹é…ä¹‹å‰çš„å ä½ç¬¦ xxxxx...)
          sed -i "s/id = \"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\"/id = \"$KV_ID\"/g" wrangler.toml
          
          # 2. æ³¨å…¥å¯†ç  (æ›¿æ¢ PASSWORD = "..." æ ¼å¼)
          # ä½¿ç”¨åŒå¼•å·åŒ…è£¹ sed è¡¨è¾¾å¼ä»¥è§£æå˜é‡
          sed -i 's/PASSWORD = ".*"/PASSWORD = "'"$USER_PASSWORD"'"/' wrangler.toml
          
          echo "Configuration updated successfully."
          # éªŒè¯æ›¿æ¢ç»“æœ (ä¸ºäº†å®‰å…¨ä¸æ‰“å°å¯†ç è¡Œ)
          grep "id =" wrangler.toml

      # 6. æ‰§è¡Œéƒ¨ç½²
      - name: Deploy to Cloudflare Workers
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CF_API_TOKEN }}
          accountId: ${{ secrets.CF_ACCOUNT_ID }}
          command: deploy